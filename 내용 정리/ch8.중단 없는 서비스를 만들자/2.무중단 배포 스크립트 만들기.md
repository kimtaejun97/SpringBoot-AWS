# 무중단 배포스크립트 만들기

## API 추가
*****
> 배포 시에 8081, 8082를 판단하는 기준이 되는 API



- ### profileController
```java
@RequiredArgsConstructor
@RestController
public class ProfileController {
    private final Environment env;

    @GetMapping("/profile")
    public String profile() {
        List<String> profiles = Arrays.asList(env.getActiveProfiles());
        List<String> realProfiles = Arrays.asList("real", "real1", "real2");
        String defaultProfiles = profiles.isEmpty()? "default": profiles.get(0);

        return profiles.stream()
                .filter(realProfiles::contains)
                .findAny()
                .orElse(defaultProfiles);
    }
}
```

    - 현재 실행중인 ActiveProfile을 모두 가져오고, 배포에 사용될 profile중 하나라도 있으면 그것을 반환,
    없다면 defaultProfiles를 반환.

- ### profileControllerTest
```java
public class ProfileControllerUnitTest {

    @Test
    public  void real_profile_조회(){
        String expectedProfile = "real";
        MockEnvironment env = new MockEnvironment();
        env.addActiveProfile(expectedProfile);
        env.addActiveProfile("oauth");
        env.addActiveProfile("real-db");

        ProfileController controller = new ProfileController(env);

        String profile = controller.profile();

        assertThat(profile).isEqualTo(expectedProfile);
    }
}
```
    - Environment는 인터페이스기 때문에 가짜 구현체인 MockEnvironment를 이용하여 쉽게 테스트할 수 있다.
    - 생성자 DI이기 때문에 사용할 수 있는 방법, @Autowired로 주입받았다면 불가능.

- ### SecurityConfig 수정
```java
.antMatchers("/","./css/**","/images/**",
        "/js/**","/h2-console/**,","/profile").permitAll()
```
    - 인증 없이도 /profile이 호출 될 수 있도록 추가.

- ### Security 검증.
```java
@RunWith(SpringRunner.class)
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
public class ProfileControllerTest {

    @LocalServerPort
    private int port;

    @Autowired
    private TestRestTemplate restTemplate;

    @Test
    public void profile은_인증없이_호출된다(){
            String expected = "default";

        ResponseEntity<String> responseEntity = restTemplate.getForEntity("/profile", String.class);

        assertThat(responseEntity.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(responseEntity.getBody()).isEqualTo(expected);
    }
}
```